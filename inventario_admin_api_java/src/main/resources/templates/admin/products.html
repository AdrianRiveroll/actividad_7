<!doctype html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Productos</title>
  <link rel="stylesheet" th:href="@{/css/app.css}"/>
</head>
<body>
<div class="container">
  <div th:replace="admin/_nav :: nav"></div>

  <header class="header">
    <h1>Productos</h1>

    <form class="search" method="get" th:action="@{/admin/products}">
      <input name="q" th:value="${q}" placeholder="Buscar por nombre o marca...">
      <button type="submit">Buscar</button>
    </form>
  </header>

  <section class="grid">

    <!-- ===================== ALTA DE PRODUCTO ===================== -->
    <div class="panel">
      <h2>Alta de producto</h2>

      <form class="form"
            th:action="@{/admin/products}"
            th:object="${productForm}"
            method="post">

        <!-- ✅ CSRF (si no lo pones, a veces NO guarda y/o da comportamientos raros con security) -->
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

        <!-- ✅ Resumen de errores -->
        <div class="hint" th:if="${#fields.hasAnyErrors()}">
          <div class="error">
            <div th:each="err : ${#fields.allErrors()}" th:text="${err}"></div>
          </div>
        </div>

        <label>Nombre</label>
        <input th:field="*{name}" type="text" required />
        <small class="error" th:if="${#fields.hasErrors('name')}" th:errors="*{name}"></small>

        <label>Marca</label>
        <input th:field="*{brand}" type="text" required />
        <small class="error" th:if="${#fields.hasErrors('brand')}" th:errors="*{brand}"></small>

        <label>Capacidad</label>
        <input th:field="*{storageCapacity}" type="text" required />
        <small class="error" th:if="${#fields.hasErrors('storageCapacity')}" th:errors="*{storageCapacity}"></small>

        <label>Stock</label>
        <input th:field="*{stock}" type="number" min="0" required />
        <small class="error" th:if="${#fields.hasErrors('stock')}" th:errors="*{stock}"></small>

        <label>Precio</label>
        <input th:field="*{price}" type="number" step="0.01" min="0" required />
        <small class="error" th:if="${#fields.hasErrors('price')}" th:errors="*{price}"></small>

        <button type="submit">Guardar</button>
      </form>
    </div>

    <!-- ===================== LISTADO ===================== -->
    <div class="panel">
      <h2>Listado</h2>
      <div class="tableWrap">
        <table>
          <thead>
          <tr>
            <th>ID</th>
            <th>Producto</th>
            <th>Marca</th>
            <th>Cap.</th>
            <th>Stock</th>
            <th>Precio</th>
            <th>Acciones</th>
          </tr>
          </thead>
          <tbody>
          <tr th:each="p : ${products}">
            <td th:text="${p.id}"></td>
            <td th:text="${p.name}"></td>
            <td th:text="${p.brand}"></td>
            <td th:text="${p.storageCapacity}"></td>
            <td th:text="${p.stock}"></td>
            <td th:text="${p.price}"></td>
            <td class="actions">
              <a class="btnGhost" th:href="@{'/admin/products/' + ${p.id} + '/edit'}">Editar</a>

              <form th:action="@{'/admin/products/' + ${p.id} + '/delete'}" method="post" style="display:inline;">
                <!-- ✅ CSRF también aquí -->
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <button class="btnDanger" type="submit"
                        onclick="return confirm('¿Eliminar producto?')">Eliminar</button>
              </form>
            </td>
          </tr>

          <tr th:if="${#lists.isEmpty(products)}">
            <td colspan="7" style="opacity:.7; padding:14px;">No hay productos para mostrar.</td>
          </tr>
          </tbody>
        </table>
      </div>
    </div>

  </section>
</div>
</body>
</html>
